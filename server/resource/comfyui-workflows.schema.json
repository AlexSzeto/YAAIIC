{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "ComfyUI Workflows Configuration",
  "description": "Schema for comfyui-workflows.json defining how the server exposes and executes ComfyUI workflows",
  "type": "object",
  "properties": {
    "defaultImageGenerationTasks": {
      "type": "array",
      "description": "LLM-based analysis tasks that run after image generation by default",
      "items": {
        "$ref": "#/definitions/llmTask"
      }
    },
    "workflows": {
      "type": "array",
      "description": "Array of workflow definition objects",
      "items": {
        "$ref": "#/definitions/workflow"
      }
    }
  },
  "required": ["workflows"],
  "additionalProperties": false,
  "definitions": {
    "llmTask": {
      "type": "object",
      "description": "An LLM task or template task for pre/post-generation processing",
      "properties": {
        "model": {
          "type": "string",
          "description": "Ollama model name to use for inference (mutually exclusive with template)"
        },
        "imagePath": {
          "type": "string",
          "description": "Variable name containing the image path for vision tasks (e.g., 'saveImagePath', 'image_0')"
        },
        "prompt": {
          "type": "string",
          "description": "The prompt text sent to the LLM. Supports {{variableName}} placeholders"
        },
        "template": {
          "type": "string",
          "description": "Template string with {{variableName}} placeholders (mutually exclusive with model)"
        },
        "to": {
          "type": "string",
          "description": "Target field name to store the result (e.g., 'description', 'summary', 'name', 'tags')"
        },
        "replaceBlankFieldOnly": {
          "type": "boolean",
          "description": "If true, only runs the task if the target field is empty",
          "default": false
        }
      },
      "required": ["to"],
      "oneOf": [
        {
          "required": ["model"],
          "not": {
            "required": ["template"]
          }
        },
        {
          "required": ["template"],
          "not": {
            "required": ["model"]
          }
        }
      ],
      "additionalProperties": false
    },
    "workflow": {
      "type": "object",
      "description": "A workflow definition object",
      "properties": {
        "name": {
          "type": "string",
          "description": "The unique display name of the workflow"
        },
        "options": {
          "$ref": "#/definitions/workflowOptions",
          "description": "UI behavior and validation configuration"
        },
        "base": {
          "type": "string",
          "description": "The filename of the underlying ComfyUI workflow JSON file in server/resource/"
        },
        "imageFormat": {
          "type": "string",
          "description": "The output file format",
          "enum": ["png", "jpg", "jpeg", "webp", "gif"],
          "default": "png"
        },
        "audioFormat": {
          "type": "string",
          "description": "The output audio file format",
          "enum": ["mp3", "wav", "flac", "ogg"],
          "default": "mp3"
        },
        "finalNode": {
          "type": "string",
          "description": "The node ID of the final output node in the workflow"
        },
        "upload": {
          "type": "array",
          "description": "Defines how to handle uploaded files and map them to internal variables",
          "items": {
            "$ref": "#/definitions/uploadMapping"
          }
        },
        "replace": {
          "type": "array",
          "description": "Defines dynamic modifications to the base ComfyUI workflow JSON before execution",
          "items": {
            "oneOf": [
              {
                "$ref": "#/definitions/directReplacement"
              },
              {
                "$ref": "#/definitions/conditionalReplacement"
              }
            ]
          }
        },
        "preGenerationTasks": {
          "type": "array",
          "description": "LLM tasks or template tasks to run before generation starts",
          "items": {
            "$ref": "#/definitions/llmTask"
          }
        },
        "postGenerationTasks": {
          "type": "array",
          "description": "LLM tasks or template tasks to run after generation completes (overrides defaultImageGenerationTasks)",
          "items": {
            "$ref": "#/definitions/llmTask"
          }
        },
        "extractOutputPathFromTextFile": {
          "type": "string",
          "description": "For video workflows that output to a file path stored in a text file"
        }
      },
      "required": ["name", "options", "base", "finalNode"],
      "additionalProperties": false
    },
    "workflowOptions": {
      "type": "object",
      "description": "Controls UI behavior and input validation",
      "properties": {
        "type": {
          "type": "string",
          "description": "The generation mode",
          "enum": ["image", "video", "audio", "inpaint"]
        },
        "autocomplete": {
          "type": "boolean",
          "description": "Whether to enable Danbooru tag autocompletion for prompts",
          "default": false
        },
        "inputImages": {
          "type": "integer",
          "description": "Number of input images required",
          "minimum": 0,
          "default": 0
        },
        "inputAudios": {
          "type": "integer",
          "description": "Number of input audio clips required",
          "minimum": 0,
          "default": 0
        },
        "optionalPrompt": {
          "type": "boolean",
          "description": "Whether the prompt field can be empty",
          "default": false
        },
        "nameRequired": {
          "type": "boolean",
          "description": "Whether the name field is required before generation",
          "default": false
        },
        "orientation": {
          "type": "string",
          "description": "Output orientation handling",
          "enum": ["portrait", "landscape", "detect"]
        },
        "hidden": {
          "type": "boolean",
          "description": "Whether to hide this workflow from client workflow lists",
          "default": false
        }
      },
      "required": ["type"],
      "additionalProperties": false
    },
    "uploadMapping": {
      "type": "object",
      "description": "Maps uploaded file to internal variable",
      "properties": {
        "from": {
          "type": "string",
          "description": "Field name in the upload (e.g., 'image_0', 'image_1', 'mask')"
        },
        "storePathAs": {
          "type": "string",
          "description": "Internal variable name to store the file path"
        }
      },
      "required": ["from", "storePathAs"],
      "additionalProperties": false
    },
    "directReplacement": {
      "type": "object",
      "description": "Direct mapping replacement that maps request data or internal variables to workflow nodes",
      "properties": {
        "from": {
          "type": "string",
          "description": "Source variable name (e.g., 'prompt', 'seed', 'saveImagePath', 'imagePath', 'firstFramePath', 'ollamaAPIPath', 'saveAudioPath')"
        },
        "to": {
          "type": "array",
          "description": "Target path in workflow JSON: [NodeID, 'inputs', keyName]",
          "items": {
            "type": "string"
          },
          "minItems": 3,
          "maxItems": 3
        },
        "prefix": {
          "type": "string",
          "description": "Text to prepend to the value"
        },
        "postfix": {
          "type": "string",
          "description": "Text to append to the value"
        }
      },
      "required": ["from", "to"],
      "not": {
        "required": ["condition"]
      },
      "additionalProperties": false
    },
    "conditionalReplacement": {
      "type": "object",
      "description": "Conditional replacement that sets workflow values based on generation context",
      "properties": {
        "condition": {
          "type": "object",
          "description": "Condition to evaluate",
          "properties": {
            "where": {
              "type": "object",
              "description": "Source of value to check",
              "properties": {
                "generationData": {
                  "type": "string",
                  "description": "Field name in generation data (e.g., 'orientation')"
                }
              },
              "required": ["generationData"],
              "additionalProperties": false
            },
            "equals": {
              "type": "object",
              "description": "Expected value",
              "properties": {
                "value": {
                  "description": "The value to compare against"
                }
              },
              "required": ["value"],
              "additionalProperties": false
            }
          },
          "required": ["where", "equals"],
          "additionalProperties": false
        },
        "value": {
          "description": "Value to set if condition is true"
        },
        "to": {
          "type": "array",
          "description": "Target path in workflow JSON: [NodeID, 'inputs', keyName]",
          "items": {
            "type": "string"
          },
          "minItems": 3,
          "maxItems": 3
        }
      },
      "required": ["condition", "value", "to"],
      "not": {
        "required": ["from"]
      },
      "additionalProperties": false
    }
  }
}
