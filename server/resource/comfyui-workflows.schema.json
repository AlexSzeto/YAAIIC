{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "ComfyUI Workflows Configuration",
  "description": "Schema for comfyui-workflows.json defining how the server exposes and executes ComfyUI workflows",
  "type": "object",
  "properties": {
    "defaultImageGenerationTasks": {
      "type": "array",
      "description": "LLM-based analysis tasks that run after image generation by default",
      "items": {
        "$ref": "#/definitions/llmTask"
      }
    },
    "workflows": {
      "type": "array",
      "description": "Array of workflow definition objects",
      "items": {
        "$ref": "#/definitions/workflow"
      }
    }
  },
  "required": ["workflows"],
  "additionalProperties": false,
  "definitions": {
    "llmTask": {
      "type": "object",
      "description": "An LLM task, template task, or value copy task for pre/post-generation processing",
      "properties": {
        "model": {
          "type": "string",
          "description": "Ollama model name to use for inference (mutually exclusive with template and from)"
        },
        "imagePath": {
          "type": "string",
          "description": "Variable name containing the image path for vision tasks (e.g., 'saveImagePath', 'image_0')"
        },
        "prompt": {
          "type": "string",
          "description": "The prompt text sent to the LLM. Supports {{variableName}} placeholders"
        },
        "template": {
          "type": "string",
          "description": "Template string with {{variableName}} placeholders (mutually exclusive with model and from)"
        },
        "from": {
          "type": "string",
          "description": "Source field name to copy value from (mutually exclusive with model and template)"
        },
        "to": {
          "type": "string",
          "description": "Target field name to store the result (e.g., 'description', 'summary', 'name', 'tags')"
        },
        "condition": {
          "$ref": "#/definitions/condition",
          "description": "Optional condition that must be met for the task to execute"
        }
      },
      "required": ["to"],
      "oneOf": [
        {
          "required": ["model"],
          "not": {
            "anyOf": [
              { "required": ["template"] },
              { "required": ["from"] }
            ]
          }
        },
        {
          "required": ["template"],
          "not": {
            "anyOf": [
              { "required": ["model"] },
              { "required": ["from"] }
            ]
          }
        },
        {
          "required": ["from"],
          "not": {
            "anyOf": [
              { "required": ["model"] },
              { "required": ["template"] }
            ]
          }
        }
      ],
      "additionalProperties": false
    },
    "workflow": {
      "type": "object",
      "description": "A workflow definition object",
      "properties": {
        "name": {
          "type": "string",
          "description": "The unique display name of the workflow"
        },
        "hidden": {
          "type": "boolean",
          "description": "Whether to hide this workflow from client workflow lists",
          "default": false
        },
        "options": {
          "$ref": "#/definitions/workflowOptions",
          "description": "UI behavior and validation configuration"
        },
        "base": {
          "type": "string",
          "description": "The filename of the underlying ComfyUI workflow JSON file in server/resource/"
        },
        "replace": {
          "type": "array",
          "description": "Defines dynamic modifications to the base ComfyUI workflow JSON before execution",
          "items": {
            "oneOf": [
              {
                "$ref": "#/definitions/directReplacement"
              },
              {
                "$ref": "#/definitions/conditionalReplacement"
              }
            ]
          }
        },
        "preGenerationTasks": {
          "type": "array",
          "description": "LLM tasks or template tasks to run before generation starts",
          "items": {
            "$ref": "#/definitions/llmTask"
          }
        },
        "postGenerationTasks": {
          "type": "array",
          "description": "LLM tasks or template tasks to run after generation completes (overrides defaultImageGenerationTasks)",
          "items": {
            "$ref": "#/definitions/llmTask"
          }
        },
        "extractOutputPathFromTextFile": {
          "type": "string",
          "description": "For video workflows that output to a file path stored in a text file"
        },
        "extractOutputTexts": {
          "type": "array",
          "description": "Array of property names to extract text content from storage folder files (e.g., ['summary'] reads summary.txt and assigns to generationData.summary)",
          "items": {
            "type": "string"
          }
        }
      },
      "required": ["name", "options", "base"],
      "additionalProperties": false
    },
    "workflowOptions": {
      "type": "object",
      "description": "Controls UI behavior and input validation",
      "properties": {
        "type": {
          "type": "string",
          "description": "The generation mode",
          "enum": ["image", "video", "audio", "inpaint"]
        },
        "autocomplete": {
          "type": "boolean",
          "description": "Whether to enable Danbooru tag autocompletion for prompts",
          "default": false
        },
        "inputImages": {
          "type": "integer",
          "description": "Number of input images required",
          "minimum": 0,
          "default": 0
        },
        "inputAudios": {
          "type": "integer",
          "description": "Number of input audio clips required",
          "minimum": 0,
          "default": 0
        },
        "optionalPrompt": {
          "type": "boolean",
          "description": "Whether the prompt field can be empty",
          "default": false
        },
        "nameRequired": {
          "type": "boolean",
          "description": "Whether the name field is required before generation",
          "default": false
        },
        "orientation": {
          "type": "string",
          "description": "Output orientation handling",
          "enum": ["portrait", "landscape", "detect"]
        },
        "extraInputs": {
          "type": "array",
          "description": "Additional input fields to render in the UI for this workflow",
          "items": {
            "$ref": "#/definitions/extraInput"
          }
        }
      },
      "required": ["type"],
      "additionalProperties": false
    },
    "extraInput": {
      "type": "object",
      "description": "Defines an additional input field for the workflow",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for this input (used as field name in generation data)"
        },
        "type": {
          "type": "string",
          "description": "Input type",
          "enum": ["text", "number", "select", "checkbox", "textarea"]
        },
        "label": {
          "type": "string",
          "description": "Display label for the input field"
        },
        "default": {
          "description": "Default value for the input (type depends on input type)"
        },
        "options": {
          "type": "array",
          "description": "Available options for select type inputs",
          "items": {
            "type": "object",
            "properties": {
              "label": {
                "type": "string",
                "description": "Display text for the option"
              },
              "value": {
                "description": "Value to use when this option is selected"
              }
            },
            "required": ["label", "value"],
            "additionalProperties": false
          }
        }
      },
      "required": ["id", "type", "label"],
      "additionalProperties": false
    },
    "directReplacement": {
      "type": "object",
      "description": "Direct mapping replacement that maps request data or internal variables to workflow nodes",
      "properties": {
        "from": {
          "type": "string",
          "description": "Source variable name (e.g., 'prompt', 'seed', 'saveImagePath', 'imagePath', 'firstFramePath', 'ollamaAPIPath', 'saveAudioPath'). For uploaded files, use 'image_N_filename' (where N = 0 to inputImages-1), 'audio_N_filename' (where N = 0 to inputAudios-1), or 'mask_filename' (for inpaint workflows) â€” these are auto-derived by the router from options.inputImages, options.inputAudios, and options.type."
        },
        "to": {
          "type": "array",
          "description": "Target path in workflow JSON: [NodeID, 'inputs', keyName]",
          "items": {
            "type": "string"
          },
          "minItems": 3,
          "maxItems": 3
        }
      },
      "required": ["from", "to"],
      "not": {
        "required": ["condition"]
      },
      "additionalProperties": false
    },
    "condition": {
      "type": "object",
      "description": "A condition that can be a simple comparison, OR condition, or AND condition",
      "oneOf": [
        {
          "type": "object",
          "description": "Simple condition with where/equals",
          "properties": {
            "where": {
              "type": "object",
              "description": "Source of value to check",
              "properties": {
                "data": {
                  "type": "string",
                  "description": "Field name in data object (e.g., 'orientation', 'name')"
                },
                "generationData": {
                  "type": "string",
                  "description": "Field name in generation data (e.g., 'orientation')"
                }
              },
              "additionalProperties": false
            },
            "equals": {
              "type": "object",
              "description": "Expected value",
              "properties": {
                "value": {
                  "description": "The value to compare against (undefined, null, and whitespace-only strings are treated as blank when comparing with empty string)"
                }
              },
              "required": ["value"],
              "additionalProperties": false
            }
          },
          "required": ["where", "equals"],
          "additionalProperties": false
        },
        {
          "type": "object",
          "description": "OR condition - true if any subcondition is true",
          "properties": {
            "or": {
              "type": "array",
              "description": "Array of conditions, at least one must be true",
              "items": {
                "$ref": "#/definitions/condition"
              },
              "minItems": 1
            }
          },
          "required": ["or"],
          "additionalProperties": false
        },
        {
          "type": "object",
          "description": "AND condition - true only if all subconditions are true",
          "properties": {
            "and": {
              "type": "array",
              "description": "Array of conditions, all must be true",
              "items": {
                "$ref": "#/definitions/condition"
              },
              "minItems": 1
            }
          },
          "required": ["and"],
          "additionalProperties": false
        }
      ]
    },
    "conditionalReplacement": {
      "type": "object",
      "description": "Conditional replacement that sets workflow values based on generation context",
      "properties": {
        "condition": {
          "$ref": "#/definitions/condition",
          "description": "Condition to evaluate"
        },
        "value": {
          "description": "Value to set if condition is true"
        },
        "to": {
          "type": "array",
          "description": "Target path in workflow JSON: [NodeID, 'inputs', keyName]",
          "items": {
            "type": "string"
          },
          "minItems": 3,
          "maxItems": 3
        }
      },
      "required": ["condition", "value", "to"],
      "not": {
        "required": ["from"]
      },
      "additionalProperties": false
    }
  }
}
